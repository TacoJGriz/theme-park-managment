<%
    let tierSlug = '';
    if (receipt.is_member && receipt.member_type) {
        const typeName = receipt.member_type.toLowerCase().split(' ')[0];
        if (typeName === 'platinum' || typeName === 'gold' || typeName === 'silver' || typeName === 'family') {
            tierSlug = 'tier-' + typeName;
        }
    }
%>

<style>
    :root {
        --ticket-gold: #ffc107;
        --ticket-dark: #343a40;
        --ticket-blue: #17a2b8;
        --bg-color: #222;
        --primary: #6f42c1;
        --success: #28a745;
        --light: #f8f9fa;
        --white: #ffffff;
        --gray: #6c757d;
        --shadow-lg: 0 10px 30px rgba(0,0,0,0.15);
        --radius: 16px;
        --accent: #17a2b8;
    }

    body {
        background-color: var(--bg-color);
        color: var(--dark);
        font-family: 'Poppins', sans-serif;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 2em;
        min-height: 100vh;
    }

    .container {
        max-width: 500px;
        width: 95%;
        margin-bottom: 3em;
        padding: 0;
    }

    .page-header {
        text-align: center;
        margin-bottom: 30px;
        animation: fadeIn 1s;
        color: var(--white);
    }

    .page-header h1 {
        font-family: 'Lobster', cursive;
        font-size: 3em;
        color: var(--ticket-gold);
        margin: 0;
        text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }

    .page-header p {
        color: var(--white);
    }

    .receipt-card {
        background: var(--white) !important;
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        color: var(--dark) !important;
        animation: floatUp 0.4s ease-out;
        width: 100%;
    }

    .receipt-header.tier-platinum {
        background: linear-gradient(135deg, #6f42c1, #8e44ad) !important;
        color: white !important;
    }

    .receipt-header.tier-gold {
        background: linear-gradient(135deg, #ffc107, #ffca2c) !important;
        color: #333 !important;
    }

    .receipt-header.tier-silver {
        background: linear-gradient(135deg, #e9ecef, #dee2e6) !important;
        color: #333 !important;
    }

    .receipt-header.tier-family {
        background: linear-gradient(135deg, #17a2b8, #20c997) !important;
        color: white !important;
    }

    .receipt-header {
        background: linear-gradient(135deg, var(--primary), #5a32a3);
        color: white;
        padding: 2.5em 2em;
        text-align: center;
    }

    .receipt-header h1 {
        font-family: 'Lobster', cursive;
        margin: 0;
        font-size: 2.8em;
        text-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .receipt-header p {
        margin: 0.2em 0 0 0;
        font-size: 1em;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        opacity: 0.9;
        font-weight: 600;
    }

    .receipt-body {
        padding: 2.5em;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 0;
        border-bottom: 1px solid #f0f0f0;
        font-size: 1em;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .label {
        color: var(--gray);
        font-weight: 600;
        font-size: 0.9em;
        text-transform: uppercase;
    }

    .value.main {
        color: var(--dark) !important;
        font-size: 1.2em;
        font-weight: 700;
    }

    .value {
        font-weight: 600;
        color: var(--dark);
        text-align: right;
    }

    .value.id {
        font-family: 'Courier New', monospace;
        letter-spacing: 1px;
    }

    .guest-pass-box {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        border-radius: 8px;
        padding: 1em;
        margin-top: 1.5em;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .guest-pass-text {
        color: #856404;
        font-weight: 600;
        font-size: 0.9em;
    }

    .guest-pass-val {
        color: #856404;
        font-weight: 700;
        font-size: 1.1em;
    }

    .sub-list {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.2em;
        margin-top: 1.5em;
        border: 1px solid #eee;
    }

    .sub-item {
        display: flex;
        justify-content: space-between;
        font-size: 0.95em;
        margin-bottom: 8px;
    }

    .receipt-footer {
        background: #f8f9fa;
        padding: 2em;
        border-top: 2px dashed #ccc;
    }

    .footer-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .footer-label {
        font-weight: 700;
        font-size: 1.2em;
    }

    .footer-value {
        font-weight: 700;
        font-size: 1.8em;
        color: var(--dark);
    }

    .footer-actions {
        margin-top: 30px;
        text-align: center;
        width: 100%;
    }

    .btn-print {
        background: var(--ticket-dark);
        color: var(--white);
        border: 1px solid rgba(255,255,255,0.3);
        padding: 12px 20px;
        border-radius: 30px;
        cursor: pointer;
        font-size: 1.1em;
        transition: 0.2s;
        margin-bottom: 15px;
        width: 80%;
        max-width: 300px;
    }

    .btn-print:hover {
        background: var(--ticket-dark);
        color: var(--white);
        border-color: var(--white);
    }

    .log-another-link {
        display: block;
        margin-top: 15px;
        color: var(--ticket-gold);
        text-decoration: none;
        font-weight: 700;
        font-size: 1.2em;
    }

    .log-another-link:hover {
        text-decoration: underline;
    }

    .btn-close {
        display: block;
        width: 100%;
        padding: 16px;
        text-align: center;
        background-color: var(--primary);
        color: white;
        text-decoration: none;
        font-weight: 700;
        border-radius: 30px;
        transition: all 0.2s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        font-size: 1.1em;
    }
</style>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Visit Confirmation | Primus Park</title>
    <link href="https://fonts.googleapis.com/css2?family=Lobster&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body class="ticket-mode">
    <div class="page-header">
        <h1>Visit Confirmation</h1>
        <p>Your visit is confirmed.</p>
    </div>

    <div class="container">
        <div class="receipt-card">
            <div class="receipt-header <%= tierSlug %>">
                <h1>Primus Park</h1>
                <p>Visit Confirmation</p>
            </div>
            <div class="receipt-body">
                <div class="info-row"><span class="label">Date</span><span class="value"><%= receipt.visit_date %></span></div>
                <div class="info-row"><span class="label">Ticket Type</span>
                    <span class="value main">
                        <%= receipt.ticket_name %>
                    </span>
                </div>

                <div class="info-row"><span class="label">Member Name</span><span class="value"><%= receipt.member_name %></span></div>
                <div class="info-row"><span class="label">Member ID</span><span class="value id"><%= (receipt.member_id || '').substring(0,8).toUpperCase() %></span></div>


                <% if (receipt.ticket_name === 'Guest Pass') { %>
                    <div class="guest-pass-box">
                        <span class="guest-pass-text">Guest Passes Used</span>
                        <span class="guest-pass-val">1 Pass (Remaining: <%= receipt.guest_passes_remaining %>)</span>
                    </div>
                <% } %>

                <% if (receipt.subMembers && receipt.subMembers.length > 0) { %>
                    <div class="sub-list">
                        <div style="font-weight:bold; font-size:0.8em; color:var(--gray); text-transform:uppercase; margin-bottom:10px;">Group Members Checked In</div>
                        <% receipt.subMembers.forEach(sub => { %>
                            <div class="sub-item"><span><%= sub.first_name %> <%= sub.last_name %></span><span class="value id" style="font-size:0.9em;"><%= (sub.membership_id || '').substring(0,8).toUpperCase() %></span></div>
                        <% }); %>
                    </div>
                <% } %>

                <div class="info-row" style="margin-top:15px; border-top: 1px solid #f0f0f0; padding-top: 15px;">
                    <span class="label">Logged By</span><span class="value" style="font-size:0.9em;"><%= receipt.staff_name %></span>
                </div>
            </div>
            <div class="receipt-footer">
                <div class="footer-row"><span class="footer-label">Total Cost</span><span class="footer-value">$<%= receipt.total_cost.toFixed(2) %></span></div>
            </div>
        </div>

        <div class="footer-actions">
            <button class="btn-print" onclick="window.print()">Print Receipt</button>

            <% if (typeof fromLogVisit !== 'undefined' && fromLogVisit) {
                let returnLink = "/visits/new";
                if (typeof returnQuery !== 'undefined' && returnQuery) {
                    returnLink += "?" + returnQuery;
                }
            %>
                <a href="<%= returnLink %>" class="log-another-link">Log Another Visit</a>
            <% } %>

            <% if (typeof fromLogVisit === 'undefined' || !fromLogVisit) { %>
                <% if (typeof fromEmployee !== 'undefined' && fromEmployee) { %>
                    <%# Since history opens this in a new tab, we simply close it %>
                    <a href="#" onclick="window.close(); return false;" class="log-another-link" style="margin-top: 15px; display: block;">&times; Close Receipt</a>
                <% } else { %>
                     <a href="/member/history" class="log-another-link" style="margin-top: 15px; display: block;">&laquo; Back to Visits</a>
                <% } %>
            <% } %>
        </div>
    </div>
</body>
</html>